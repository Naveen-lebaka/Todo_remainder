<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>ToDo Reminder App</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        /* Popup styling */
        #popup {
            display: none;
            position: fixed;
            top: 30%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            padding: 25px 30px;
            z-index: 9999;
            text-align: center;
            width: 300px;
        }

        #popup h2 {
            color: #007bff;
        }

        #popup button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            margin-top: 15px;
            cursor: pointer;
        }

        #popup button:hover {
            background: #0056b3;
        }

        #overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 9998;
        }

        #time-display {
            text-align: center;
            margin-top: 15px;
            color: #333;
            font-size: 16px;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>ðŸ•’ ToDo Reminder App</h1>

        <form method="POST" action="/add" class="form">
            <input type="text" name="title" placeholder="Enter task title" required>
            <input type="datetime-local" name="time" required>

            <select name="frequency">
                <option value="">One Time</option>
                <option value="daily">Every Day</option>
                <option value="monthly">Every Month</option>
                <option value="yearly">Every Year</option>
            </select>

            <button type="submit">Add Task</button>
        </form>

        <ul class="task-list">
            {% for task in tasks %}
            <li>
                <b>{{ task.title }}</b> at {{ task.time }}
                {% if task.frequency %}
                ({{ task.frequency }})
                {% endif %}
                <a href="/complete/{{ task.id }}" class="done">âœ” Mark as Read</a>
            </li>
            {% else %}
            <p>No tasks yet!</p>
            {% endfor %}
        </ul>

        {% with messages = get_flashed_messages() %}
        {% if messages %}
        <div class="alert">
            {% for msg in messages %}
            <p>{{ msg }}</p>
            {% endfor %}
        </div>
        {% endif %}
        {% endwith %}

        <div id="time-display"></div>
    </div>

    <!-- Overlay and popup -->
    <div id="overlay"></div>
    <div id="popup">
        <h2 id="popup-title"></h2>
        <p>It's time to complete your task!</p>
        <button id="mark-done">Mark as Read</button>
    </div>

    <!-- Alarm Sound -->
    <audio id="alarm-sound" src="https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg"></audio>

    <script>
        async function fetchReminders() {
            const response = await fetch("/reminder-data");
            return await response.json();
        }

        function getCurrentTimeFormatted() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            return `${year}-${month}-${day}T${hours}:${minutes}`;
        }

        function showPopup(task) {
            document.getElementById("popup-title").innerText = task.title;
            document.getElementById("popup").style.display = "block";
            document.getElementById("overlay").style.display = "block";

            // Play alarm
            const sound = document.getElementById("alarm-sound");
            sound.play();

            document.getElementById("mark-done").onclick = () => {
                window.location.href = `/complete/${task.id}`;
            };
        }

        async function checkReminders() {
            const reminders = await fetchReminders();
            const nowTime = getCurrentTimeFormatted();
            document.getElementById("time-display").innerText = "Current Time: " + nowTime.replace("T", " ");

            reminders.forEach(task => {
                if (task.time === nowTime) {
                    showPopup(task);
                }
            });
        }

        // Check reminders every 10 seconds
        setInterval(checkReminders, 10000);
        checkReminders();
    </script>
</body>

</html>