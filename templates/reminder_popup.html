<!-- reminder_popup.html -->
<style>
    /* popup styles */
    #popup {
        display: none;
        position: fixed;
        top: 30%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: linear-gradient(180deg, #fff 0%, #f9fbff 100%);
        border-radius: 12px;
        box-shadow: 0 10px 35px rgba(15, 23, 42, 0.2);
        padding: 24px 28px;
        z-index: 9999;
        text-align: center;
        width: 340px;
        font-family: 'Poppins', sans-serif;
    }

    #popup h2 {
        color: #0b57d0;
        margin-bottom: 6px;
        font-size: 20px;
        font-weight: 600;
    }

    #popup p {
        color: #374151;
        margin-bottom: 12px;
    }

    #popup button {
        background: #0b57d0;
        color: white;
        border: none;
        padding: 10px 18px;
        border-radius: 8px;
        margin-top: 8px;
        cursor: pointer;
        font-weight: 600;
    }

    #overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(8, 15, 22, 0.45);
        z-index: 9998;
    }
</style>

<div id="overlay"></div>
<div id="popup">
    <h2 id="popup-title">Reminder</h2>
    <p>It's time to complete your task!</p>
    <div style="display:flex; gap:10px; justify-content:center;">
        <button id="mark-done">Mark as Read</button>
        <button id="snooze-5" class="btn">Snooze 5m</button>
    </div>
</div>

<!-- Alarm Sound -->
<audio id="alarm-sound" src="https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg"></audio>

<script>
    let isDND = false;
    let missedReminders = [];
    let interval = 10000;
    let intervalId = null;
    let currentPopTask = null;

    // read DND checkbox from header
    function initDND() {
        const dndToggle = document.getElementById("dnd-toggle");
        if (dndToggle) {
            isDND = dndToggle.checked || false;
            dndToggle.addEventListener("change", () => {
                isDND = dndToggle.checked;
                if (!isDND) checkMissedReminders();
            });
        }
    }

    document.addEventListener("DOMContentLoaded", () => {
        initDND();
    });

    async function fetchReminders() {
        const response = await fetch("/reminder-data");
        return await response.json();
    }

    function getCurrentDateTime() {
        const now = new Date();
        const date = now.toISOString().split('T')[0];
        const time = now.toTimeString().slice(0, 5);
        return { date, time };
    }

    function showPopup(task) {
        currentPopTask = task;
        if (isDND) return;
        document.getElementById("popup-title").innerText = task.title;
        document.getElementById("popup").style.display = "block";
        document.getElementById("overlay").style.display = "block";
        const sound = document.getElementById("alarm-sound");
        sound.play();

        document.getElementById("mark-done").onclick = () => {
            window.location.href = `/complete/${task.id}`;
        };

        document.getElementById("snooze-5").onclick = () => {
            document.getElementById("popup").style.display = "none";
            document.getElementById("overlay").style.display = "none";
            setTimeout(() => {
                missedReminders.push(task);
            }, 300000); // 5 min
        };
    }

    function checkMissedReminders() {
        if (missedReminders.length > 0) {
            missedReminders.forEach(task => showPopup(task));
            missedReminders = [];
        }
    }

    async function dynamicCheck() {
        const reminders = await fetchReminders();
        const now = new Date();
        let nearestDiff = Infinity;

        reminders.forEach(task => {
            const taskDateTime = new Date(`${task.date}T${task.time}:00`);
            const diff = taskDateTime - now;
            if (diff > 0 && diff < nearestDiff) nearestDiff = diff;
        });

        if (nearestDiff <= 5000) interval = 1000;
        else if (nearestDiff > 10000) interval = 10000;

        const { date, time } = getCurrentDateTime();
        const timeDisplay = document.getElementById("time-display");
        if (timeDisplay) {
            timeDisplay.innerText = "Current Time: " + date + " " + time + (isDND ? " ðŸ”• (DND On)" : "");
        }

        reminders.forEach(task => {
            if (task.date === date && task.time === time) {
                if (isDND) {
                    missedReminders.push(task);
                } else {
                    showPopup(task);
                }
            }
        });

        clearInterval(intervalId);
        intervalId = setInterval(dynamicCheck, interval);
    }

    dynamicCheck();
</script>