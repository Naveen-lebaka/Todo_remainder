<!-- reminder_popup.html -->
<style>
    /* Popup styling */
    #popup {
        display: none;
        position: fixed;
        top: 30%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        padding: 25px 30px;
        z-index: 9999;
        text-align: center;
        width: 300px;
    }

    #popup h2 {
        color: #007bff;
    }

    #popup button {
        background: #007bff;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 6px;
        margin-top: 15px;
        cursor: pointer;
    }

    #popup button:hover {
        background: #0056b3;
    }

    #overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 9998;
    }

    #time-display {
        text-align: center;
        margin-top: 15px;
        color: #333;
        font-size: 16px;
    }

    /* DND toggle switch */
    .dnd-toggle {
        display: flex;
        align-items: center;
        justify-content: center;
        margin-top: 15px;
        font-size: 16px;
    }

    .dnd-toggle input {
        margin-left: 8px;
        width: 20px;
        height: 20px;
    }
</style>

<!-- Overlay and popup -->
<div id="overlay"></div>
<div id="popup">
    <h2 id="popup-title"></h2>
    <p>It's time to complete your task!</p>
    <button id="mark-done">Mark as Read</button>
</div>

<!-- Alarm Sound -->
<audio id="alarm-sound" src="https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg"></audio>

<!-- Do Not Disturb Toggle -->
<div class="dnd-toggle">
    <label>ðŸ”• Do Not Disturb
        <input type="checkbox" id="dnd-toggle">
    </label>
</div>

<script>
    let isDND = false; // initial DND state
    let missedReminders = [];
    let interval = 10000; // default: 10 seconds
    let intervalId = null;

    // ðŸ” Detect if system/browser is in DND or Focus mode
    async function detectSystemDND() {
        // Case 1: Notification permission denied => likely in Focus/DND
        if (Notification.permission === "denied") {
            return true;
        }

        // Case 2: Tab is hidden or inactive
        if (document.hidden) {
            return true;
        }

        // Case 3: Manual toggle stored locally
        const stored = localStorage.getItem("dndMode");
        return stored === "true";
    }

    // Initialize toggle and auto DND detection
    document.addEventListener("DOMContentLoaded", async () => {
        const dndToggle = document.getElementById("dnd-toggle");
        const savedState = localStorage.getItem("dndMode");

        if (savedState === "true") {
            dndToggle.checked = true;
            isDND = true;
        }

        // Try automatic detection once on load
        const autoDND = await detectSystemDND();
        if (autoDND) {
            isDND = true;
            dndToggle.checked = true;
        }

        // Manual toggle listener
        dndToggle.addEventListener("change", () => {
            isDND = dndToggle.checked;
            localStorage.setItem("dndMode", isDND);
            if (!isDND) {
                checkMissedReminders();
            }
        });

        // Detect when user returns to tab or DND turns off
        document.addEventListener("visibilitychange", async () => {
            if (!document.hidden) {
                const sysDND = await detectSystemDND();
                if (!sysDND && isDND) {
                    // System DND turned off
                    isDND = false;
                    dndToggle.checked = false;
                    localStorage.setItem("dndMode", false);
                    checkMissedReminders();
                }
            }
        });
    });

    async function fetchReminders() {
        const response = await fetch("/reminder-data");
        return await response.json();
    }

    function getCurrentDateTime() {
        const now = new Date();
        const date = now.toISOString().split('T')[0];
        const time = now.toTimeString().slice(0, 5);
        return { date, time };
    }

    function showPopup(task) {
        if (isDND) return; // Skip popup if in DND mode

        document.getElementById("popup-title").innerText = task.title;
        document.getElementById("popup").style.display = "block";
        document.getElementById("overlay").style.display = "block";

        const sound = document.getElementById("alarm-sound");
        sound.play();

        document.getElementById("mark-done").onclick = () => {
            window.location.href = `/complete/${task.id}`;
        };
    }

    function checkMissedReminders() {
        if (missedReminders.length > 0) {
            missedReminders.forEach(task => showPopup(task));
            missedReminders = [];
        }
    }

    async function dynamicCheck() {
        const reminders = await fetchReminders();
        const now = new Date();
        let nearestDiff = Infinity;

        reminders.forEach(task => {
            const taskDateTime = new Date(`${task.date}T${task.time}:00`);
            const diff = taskDateTime - now;
            if (diff > 0 && diff < nearestDiff) nearestDiff = diff;
        });

        // Adjust check interval dynamically
        if (nearestDiff <= 5000) interval = 1000;
        else if (nearestDiff > 10000) interval = 10000;

        const { date, time } = getCurrentDateTime();
        document.getElementById("time-display").innerText =
            "Current Time: " + date + " " + time +
            (isDND ? " ðŸ”• (DND On)" : "");

        // Check each reminder
        reminders.forEach(task => {
            if (task.date === date && task.time === time) {
                if (isDND) {
                    missedReminders.push(task);
                } else {
                    showPopup(task);
                }
            }
        });

        clearInterval(intervalId);
        intervalId = setInterval(dynamicCheck, interval);
    }

    // Start reminder checking
    dynamicCheck();
</script>