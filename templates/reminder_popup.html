<!-- reminder_popup.html -->
<style>
    /* Popup styling */
    #popup {
        display: none;
        position: fixed;
        top: 30%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        padding: 25px 30px;
        z-index: 9999;
        text-align: center;
        width: 300px;
    }

    #popup h2 {
        color: #007bff;
    }

    #popup button {
        background: #007bff;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 6px;
        margin-top: 15px;
        cursor: pointer;
    }

    #popup button:hover {
        background: #0056b3;
    }

    #overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 9998;
    }

    #time-display {
        text-align: center;
        margin-top: 15px;
        color: #333;
        font-size: 16px;
    }
</style>

<!-- Overlay and popup -->
<div id="overlay"></div>
<div id="popup">
    <h2 id="popup-title"></h2>
    <p>It's time to complete your task!</p>
    <button id="mark-done">Mark as Read</button>
</div>

<!-- Alarm Sound -->
<audio id="alarm-sound" src="https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg"></audio>

<script>
    async function fetchReminders() {
        const response = await fetch("/reminder-data");
        return await response.json();
    }

    function getCurrentDateTime() {
        const now = new Date();
        const date = now.toISOString().split('T')[0]; // YYYY-MM-DD
        const time = now.toTimeString().slice(0, 5); // HH:MM
        return { date, time };
    }

    function showPopup(task) {
        document.getElementById("popup-title").innerText = task.title;
        document.getElementById("popup").style.display = "block";
        document.getElementById("overlay").style.display = "block";

        const sound = document.getElementById("alarm-sound");
        sound.play();

        document.getElementById("mark-done").onclick = () => {
            window.location.href = `/complete/${task.id}`;
        };
    }

    // ðŸ” Dynamic reminder checking interval
    let interval = 10000; // default: 10 seconds
    let intervalId = null;

    async function dynamicCheck() {
        const reminders = await fetchReminders();
        const now = new Date();

        // Find the nearest upcoming task time
        let nearestDiff = Infinity;
        reminders.forEach(task => {
            const taskDateTime = new Date(`${task.date}T${task.time}:00`);
            const diff = taskDateTime - now; // milliseconds
            if (diff > 0 && diff < nearestDiff) {
                nearestDiff = diff;
            }
        });

        // Adjust interval dynamically
        if (nearestDiff <= 10000) {
            interval = 500; // within 10 sec â†’ check every 1s
        } else if (nearestDiff > 10000) {
            interval = 10000; // more than 10 sec â†’ check every 10s
        }

        // Update current time display
        const date = now.toISOString().split('T')[0];
        const time = now.toTimeString().slice(0, 5);
        document.getElementById("time-display").innerText =
            "Current Time: " + date + " " + time;

        // Check if any task matches current time
        reminders.forEach(task => {
            if (task.date === date && task.time === time) {
                showPopup(task);
            }
        });

        // Clear previous interval and reset with new timing
        clearInterval(intervalId);
        intervalId = setInterval(dynamicCheck, interval);
    }

    // Start first check immediately
    dynamicCheck();
</script>